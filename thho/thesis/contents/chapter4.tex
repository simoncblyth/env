\chapter {Detector Simulation}

\section {Offline Software Overview}

\subsection {G4dyb}

G4dyb is a application program composed of GEANT4.
G4dyb provides many preliminary simulation tasks and could be
the validation of NuWa, the later offline software.
The version control of G4dyb is CVS in the early days and
SVN later. CMT is used to manage the configuration of G4dyb.
The latest version of G4dyb is release 2.14.1, and
G4dyb has been stopped to develop around in the middle of last year (2008).


\subsection {NuWa}

NuWa is the official offline software of Dayabay experiment.
It contains not only the physics simulation engine, but also
other offline programs, including electronic simulation,
trigger simulation, reconstruction algorithm, analysis framework, and so forth.

NuWa is a framework based on Gaudi.
%A framework -----------------------, ------------------.
%It could be realized NuWa is a assembly of many kinds of application program,
%e.g. Root, the analysis framework developed by CERN, GEANT4, and so forth.
%The framework is based on Gaudi. Gaudi is ----------------------.
NuWa communicates with GEANT4 by GiGa, Geant4 Interface for Gaudi Applications.
A typical script to control GiGa is Python.

%The simulation structure scheme is shown below.
%(NuWa simulation structure scheme)

The version control of NuWa is SVN and CMT is used to manage
the configuration of NuWa.
At the time of writing, the latest version of NuWa is 1.3.0.

%The algorithm of NuWa simulation scheme is shown below.
%(simulation algorithm scheme of NuWa)
%NuWa overview
%why NuWa
%DataModel AES TES
%Gaudi
%Giga


%\subsection {Comparison of NuWa and G4dyb}

%\section {Mock Data Challenge}

%http://dayabay.ihep.ac.cn/cgi-bin/DocDB/ShowDocument?docid=2602


%\section {Basic Distributions of Dayabay and Aberdeen Detectors}
%
%There are some basic distribution has been done to study the general
%property of both Dayabay and Aberdeen detectors by G4dyb in the early
%days and NuWa.
%
%
%(The uniformity of Dayabay AD--R)
%
%
%
%
%(The uniformity of Dayabay AD--Z)
%
%
%
%
%(Energy resolution of Dayabay AD --- at 1 mev gamma)
%
%
%
%
%(The uniformity of Aberdeen Neutron detector--R)
%
%
%
%
%(The uniformity of Aberdeen Neutron detector--Z)
%
%
%
%
%(Energy resolution of Aberdeen Detector-----at 1mev gamma)
%
%
%Because both Dayabay and Aberdeen detectors uses inverse
%beta decay as signals, the prompt and delayed signals are
%1--mev and 8------mev gamma separately. Thus
%the energy cut of gamma at 6mev is adopted.
%

%\subsection {Signal box}

%Dan, collaboration meeting June, 2009


%\section {The Effect of Reflector Position}
%\label {Reflector}
%
%Reflectors are used to enhance the p.e. number collected by the PMTs of Dayabay
%detectors. Accroding to the location to position reflectors in AD, the cost and
%manufacure process would be different. Simulation of the p.e. number difference
%between different reflector location in AD is shown below by G4dyb release--------.
%The condiction to simulate..................
%
%
%(reflector position 1, uniformity R)
%
%\begin{figure}
%    \centering
%    \includegraphics[width=0.8\textwidth]{./figure/reflector_position_pe_e_vs_r_basic_distri.png}
%    \caption{Total p.e. distribution generated along r-axis by positrons distributed uniformally in the acrylic tank.}
%    \label{fig:reflector_position_pe_e_vs_r_basic_distri.png}
%    \end{figure}
%
%
%\begin{figure}
%    \centering
%    \includegraphics[width=0.8\textwidth]{./figure/reflector_position_pe_e_vs_z_basic_distri.png}
%    \caption{Total p.e. distribution generated along z-axis by positrons distributed uniformally in the acrylic tank.}
%    \label{fig:reflector_position_pe_e_vs_r_basic_distri.png}
%    \end{figure}
%
%
%
%(reflector position 1, uniformity Z)
%
%
%
%\begin{figure}
%    \centering
%    \includegraphics[width=0.8\textwidth]{./figure/reflector_position_pe_basic_distri.png}
%    \caption{Total p.e. distribution generated by positrons distributed uniformally in the acrylic tank.}
%    \label{fig:reflector_position_pe_basic_distri.png}
%    \end{figure}
%
%
%
%(reflector position 1, total p.e.)
%
%
%
%
%(reflector position 2, uniformity R)
%
%
%
%
%(reflector position 2, uniformity Z)
%
%
%
%
%(reflector position 2, total p.e.)
%
%
%
%
%(reflector position 3, uniformity R)
%
%
%
%
%(reflector position 3, uniformity Z)
%
%
%
%
%(reflector position 3, total p.e.)
%
%
%The simulation shows the difference of total p.e. is---------------
%The cost--------------------
%So--------------------------
%Other R \& D details could be found in section--------------------.


\section {The Effect of Optical Property Measurement}
\subsection {The Behavior of Optical Photons Passing Through Acrylics}

When the optical photons passing through the acrylic panels in air, multiple refractions
and reflections occurs. A simple simulation by GEANT4 shows when 10000 optical photons
are going to pass the acrylic panel of thickness of 10 mm, the typical front-primary
reflection is around 4\%, the sum of the other orders of reflection is around 2.6\%.
The most a near-normal incident optical photon reflected is around 5 times.
The lost intensity of transmittance is attributed by the reflection but not the
absorption until the scanning comes to the UV-block region.


\begin{figure}
    \centering
    \includegraphics[width=0.4\textwidth]{OM_acrylic_sample_study.png}
    \caption[A example exhibited by GEANT4 of a optical photon has multiple reflections in a acrylic panel.]
{
A example exhibited by GEANT4 of a optical photon has multiple reflections in a acrylic panel.
}
    \label{fig:OM_acrylic_sample_study.png}
    \end{figure}


%%%%%%%%%%%%%%%%
% summary number
%%%%%%%%%%%%%%%%%%

\subsection {The Optical Model}
\label{sec:opticalModel}

The optical model of GEANT4 requires the index of refraction and the attenuation length
of matirails. The measurement method of these two parameters of acrylic pannels for Dayabay IAV
is mentioned in Sec. \ref{sec:RTMethod}.
The measurement may fail at few wavelength for some reasons, also discussed
in Sec. \ref{sec:RTMethod}.
To model the index of refraction by a smooth curve to fit in GEANT4 requirement, Cauchy equation
is used.

\begin{equation}
\label{eq:Chauchy}
n = A + \frac{B}{\lambda^2},
\end{equation}
where $A$ and $B$ are constants.


To model attenuation length, a Fermi-Dirac-like distribution


\begin{equation}
\label{eq:AttenuationModelA}
absorption\,length = {\frac{A - B}{1 + exp(\frac{\lambda - C}{\Delta})}} + B + {\frac{\lambda}{D}}A,\;if\,absorption\,length\,>\,0
\end{equation}
where $A$,$B$,$C$,and $D$ are constants. $D$ should be decided manually and is associated to the wavelength the total
absorption occurs at. And


\begin{equation}
\label{eq:AttenuationModelB}
absorption\,length = 0,\;if\,absorption\,length\,in\,Eq.\,\ref{eq:AttenuationModelA}\leq0
\end{equation}


Figure \ref{fig:rt_ior_cauchy_model_measurement_1} and Figure \ref{fig:rt_attenuation_model_measurement_1} show the comparison of the indexes of refraction and the attenuation lengths drived from the
optical model, with the measurements by RT method in Sec. \ref{sec:RTMethod}.
And also \ref{fig:rt_transmittance_measurement_model} and Figure \ref{fig:rt_reflectance_measurement_model} show the comparison of the transmittance
and reflectance derived by the Fresnel relationships and parameters
of 10 mm sample for IAV No.1 ( Figure. \ref{fig:rt_10mm_result.png}
derived by the RT method, with the transmittance and reflectance measurements.




%(comparison of n)
\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{rt_ior_cauchy_model_measurement_1.png}
    \caption[Optical model of $n$ and measurement]{Optical model of $n$ and measurement.}
    \label{fig:rt_ior_cauchy_model_measurement_1}
    \end{figure}



%(comparison of att)
\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{rt_attenuation_model_measurement_1.png}
    \caption[Optical model of attenuation length and measurement]{Optical model of attenuation length and measurement}
    \label{fig:rt_attenuation_model_measurement_1}
    \end{figure}


\begin{figure}
    \centering
    \includegraphics[width=0.4\textwidth]{rt_transmittance_measurement_model.png}
    \caption[Comparison of the transmittance derived by the optical model and the measurement]
{
Comparison of the transmittance derived by the optical model and the measurement.
Blue: The transmittance derived by the optical model.
Red: The transmittance measurement.
}
    \label{fig:rt_transmittance_measurement_model}
    \end{figure}


\begin{figure}
    \centering
    \includegraphics[width=0.4\textwidth]{rt_reflectance_measurement_model.png}
    \caption[Comparison of the reflectance derived by the optical model and the measurement.]
{
Comparison of the reflectance derived by the optical model and the measurement.
Blue: The reflectance derived by the optical model.
Red: The reflectance measurement.
}
    \label{fig:rt_reflectance_measurement_model}
    \end{figure}



\subsection{Comparison of Different Acrylic Optical Models}

A simple acrylic optical model is used both in G4dyb and NuWa. Figure \ref{fig:OM_origin_model_att.png} and
Figure \ref{fig:OM_origin_model_ior.png} shows the comparisons of the original parameters of acrylics
and the parameters of 10 mm sample for IAV No.1 ( Figure. \ref{fig:rt_10mm_result.png} derived from the RT method for the simulation in G4dyb and NuWa.


\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{OM_origin_model_att.png}
    \caption[Comparison of attenuation length of the origin acrylic material optical model and the RT method model]
{
Comparison of attenuation lengths of the origin acrylic material optical model and the RT method model.
Blue: The original attenuation lengths of the simulation model.
Red: The attenuation lengths derived by the RT method.
}
    \label{fig:OM_origin_model_att.png}
    \end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{OM_origin_model_ior.png}
    \caption[Comparison of indices of the origin acrylic material optical model and the RT method model]
{
Comparison of indices of the origin acrylic material optical model and the RT method model.
Blue: The original indices of refraction for the simulation model.
Red: The indices of refraction derived by the RT method.
}
    \label{fig:OM_origin_model_ior.png}
    \end{figure}


5000 1 MeV gammas are generated uniformly within a Dayabay AD module to test the impact of changing the optical model.
A typical simulation of p.e. number generated by Gd is shown in \ref{fig:origin_1mev_gamma_peGen_GdLS}.
For model A, there is only the property of attenuation length replaced by the RT meausrements.
For model B, there is only the property of index of refraction replaced by the RT meausrements.
For model C, all the optical parameterso of acrylics in NuWa are replaced by the RT measurements.
The comparison summary is shown in Table \ref{tab:peGenGdLSOpModel}.
Table \ref{tab:peGenGdLSOpModel} shows not obvious difference if only the refraction index term is changed.
This could be realized by the comparison of Figure \ref{fig:OM_origin_model_ior.png}. The difference of index of
refraction between the RT measurements and the origin parameters in NuWa is small.
And the effect by replacing the attenuation property is obvious. The mean value decrease by Gaussian fitting of total p.e., received by PMTs
is around 4.93\%, which the amount is large enough to be noticed by DAQ.


\begin{table}
\centering
\caption{Comparisons of total p.e. number generated within AD target
and the number of gamma stopping in IAV by 1 MeV gammas randomly distributed 
in a AD module of different optical models}
\label{tab:peGenGdLSOpModel}
\begin{tabular}{lp{1.5cm}p{1.5cm}p{2.0cm}p{6.5cm}}
Model  &  Gaussian Mean  &  Gaussian sigma &     Energy resolution (\%) & Stopping gamma number / total generated gamma number in target (\%) \\
\hline
\hline
origin  & 126.089 & 12.841 & 10.184 & 2.44115\\
A       & 118.809 & 12.4819 & 10.5059 & 3.66173\\
B       & 126.328 & 12.8293 & 10.1556 & 2.87707\\
C       & 119.869 & 13.08 & 10.9119 & 2.35397 \\
\hline
\end{tabular}
\end{table}


5000 6 MeV gammas and IBD events are also tested and summaried in Table \ref{tab:peGenGdLSOpModel6mevGamma} and Table \ref{tab:peGenGdLSOpModelIBD}.
A typical simulation of p.e. number generated by Gd for 6 MeV gamma is shown in \ref{fig:origin_6mev_gamma_peGen_GdLS} and
neutron capture of target is shown in \ref{fig:origin_ibd_nHits_onGd} for IBD events.
The neutron capture efficiency of IBD event is defined by the cut of the fitting mean of the 6 MeV gamma light yield.

\begin{table}
\centering
\caption{Comparisons of total p.e. number generated within AD target by 6 MeV gammas randomly distributed
in a AD module of different optical models}
\label{tab:peGenGdLSOpModel6mevGamma}
\begin{tabular}{lp{1.5cm}p{1.5cm}p{2.0cm}p{6.5cm}}
Model  &  Gaussian Mean  &  Gaussian sigma &     Energy resolution (\%) & Stopping gamma number / total generated gamma number in target (\%) \\
\hline
\hline
origin  & 810.323 & 42.3905 & 5.2313 & 2.97619 \\
A       & 763.096 & 44.6901 & 5.85642 & 2.89116 \\
B       & 809.405 & 45.3895 & 5.60776 & 2.55102 \\
C       & 762.795 & 44.3617 & 5.81568 & 3.48639 \\
\hline
\end{tabular}
\end{table}


\begin{table}
\centering
\caption{Comparisons of total p.e. number generated within AD target by IBD events randomly distributed
in a AD module of different optical models}
\label{tab:peGenGdLSOpModelIBD}
\begin{tabular}{llp{1.5cm}p{1.5cm}p{2.0cm}p{2.7cm}p{2.5cm}}
Model & Signal &  Gaussian Mean  &  Gaussian sigma & Energy resolution (\%) & n-Gd capture efficiency (\%) & Statistical unc. (\%) \\
\hline
\hline
origin  & n-capture by p    & 291.962 & 20.0332 & 6.86158 & -- & -- \\
origin  & n-capture by Gd   & 1059.75 & 70.0136 & 6.60664 & 87.2889 & 2.786\\
A       & n-capture by p    & 279.177 & 26.4055 & 9.45834 & -- & -- \\
A       & n-capture by Gd   & 994.83  & 68.9833 & 6.93418 & 85.8667 & 2.763 \\
B       & n-capture by p    & 295.009 & 22.5 & 7.62687 & -- & -- \\
B       & n-capture by Gd   & 1059.59 & 66.8549 & 6.30949 & 87.2 & 2.784 \\
C       & n-capture by p    & 277.547 & 22.8583 & 8.23583 & -- & -- \\
C       & n-capture by Gd   & 1001.07 & 69.004 & 6.89306 &  88.0889 & 2.798 \\
\hline
\end{tabular}
\end{table}


\begin{figure}
    \centering
    \label{fig:origin_1mev_gamma_peGen_GdLS}
    \includegraphics[width=0.4\textwidth]{origin_1mev_gamma_peGen_GdLS.png}
    \caption
[Original acrylic optical model simulates p.e. generated within a AD target by 1 MeV gammas randomly distributed in a AD module.]
{Original acrylic optical model simulates p.e. generated within a AD target by 1 MeV gammas randomly distributed in a AD module. The Gaussain-like shape shows the uniformity of the AD is good.}
    \end{figure}


\begin{figure}
    \centering
    \includegraphics[width=0.4\textwidth]{origin_6mev_gamma_peGen_GdLS.png}
    \caption
    [Original acrylic optical model simulates p.e. generated within target by 6 MeV gammas randomly distributed in a AD module]
    {Original acrylic optical model simulates p.e. generated within target by 6 MeV gammas randomly distributed in a AD module. The Gaussain-like shape shows the uniformity of the AD is good.}
    \label{fig:origin_6mev_gamma_peGen_GdLS}
    \end{figure}


\begin{figure}
    \centering
    \includegraphics[width=0.4\textwidth]{origin_ibd_nHits_onGd.png}
    \caption
    [Original acrylic optical model simulates p.e. generated within target by neutron capture of IBD events randomly distributed in a AD module]
    {Original acrylic optical model simulates p.e. generated within target by neutron capture of IBD events randomly distributed in a AD module}
    \label{fig:origin_ibd_nHits_onGd}
    \end{figure}

%\begin{figure}
%    \centering
%    \label{fig:modelC_1mev_gamma_peGen_GdLS.png}
%    \includegraphics[width=0.4\textwidth]{modelC_1mev_gamma_peGen_GdLS.png}
%    \caption
%[p.e. generated within a AD target of optical model C by 1 MeV Gamma randomly distributed in a AD module.]
%{p.e. generated within a AD target of optical model C by 1 MeV Gamma randomly distributed in a AD module. The Gaussain-like shape shows the uniformity of the AD is good.}
%    \end{figure}
%
%\begin{figure}
%    \centering
%    \includegraphics[width=0.4\textwidth]{modelC_6mev_gamma_peGen.png}
%    \caption
%    [Acrylic optical model C simulates p.e. generated within target by 6 MeV gamma distributed in AD]
%    {Acrylic optical model C simulates p.e. generated within target by 6 MeV gamma distributed in AD}
%    \label{fig:modelC_6mev_gamma_peGen.png}
%    \end{figure}
%
%
%
%\begin{figure}
%    \centering
%    \includegraphics[width=0.4\textwidth]{modelC_ibd_hits_GdLS.png}
%    \caption
%    [Acrylic optical model C simulates p.e. generated within target by neutron capture of IBD events distributed in AD]
%    {Acrylic optical model C simulates p.e. generated within target by neutron capture of IBD events distributed in AD}
%    \label{fig:modelC_6mev_gamma_peGen.png}
%    \end{figure}
%

Comparing with the attenuation length, the behavior of optical photons is mainly decided by the refraction index of material in AD sensitive
region from 300nm to 500nm because the materials are transparent, namely $\kappa$ in Equation \ref{eq:FSR}, Section \ref{sec:RTMethod}
is much smaller than $n$. Thus the simulation shows the shape of the p.e. distribution is similar
because the optical model between original one in NuWa and the RT measurement one is similar.


%\begin{table}
%\centering
%\caption{
%The p.e. number generated within AD target and resolution difference bewteen the model C and original model in NuWa by Gaussian Fit.
%The events are random distributed 1 MeV gammas within AD.
%}
%\label{tab:peGenGdLSEER}
%\begin{tabular}{lccc}
%Term & Total p.e. & Sigma & Resolution (\%) \\
%\hline
%\hline
%Origin      & 127.3     & 12    & 9.43 \\
%Model C     & 121.5     & 12.72 & 10.47 \\
%\hline
%Difference (\%) & -4.56 & 6     & 11.03 \\
%\hline
%\end{tabular}
%\end{table}


Thus, the original refraction index model of NuWa is good enough for simulation but the attenuation of acrylics is not.
Apparently the attenuation model of acrylics is too ideal and in practically the total p.e. number will be smaller.
However, the more real optical model of acrylics would not results in obvious difference of the efficiency of neutron capture by Gd.

%(comparison for dry run)
