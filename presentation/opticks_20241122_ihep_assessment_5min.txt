.. meta::
   :title: Simon C Blyth : IHEP Assessment Report
   :description: (2024 November 22) JUNO, OptiX, Opticks
   :note0: 5+2 min 

.. include:: my_s5defs.txt


:i:`Simon C. Blyth : IHEP Assessment Report`
==========================================================================================

.. raw:: html

    <div class="mytitle">
    <header>
    <h1 style="background-color:lightgrey;text-align:center;"> 
        <i>Simon C. Blyth</i> : IHEP Assessment Report 
        <h2 style="background-color:lightgrey;text-align:center">
            Open source, https://bitbucket.org/simoncblyth/opticks 
        </h2>
    </h1>
    </header>
    </div>
    <!--img style="position:absolute; top:200px; LEFT:100px; WIDTH:200px; " src="juno/JUNO_logo.png"  /-->
    <div class="mycredit">
       <h2 style="background-color:lightgrey">
          Simon C Blyth, IHEP, CAS &mdash; IHEP Assessment Report &mdash; 22 November 2024
       </h2>
    </div>

.. s5_talk:: 

    This render shows the photons resulting from a muon crossing the JUNO scintillator, 
    each line represents a single photon.

.. comment

    Opticks is an open source project that applies GPU ray tracing to optical photon simulation 
    and integrates this with Geant4. This can give drastic speedups of more than a factor of 1000.
    This approach removes memory and processing bottlenecks that can prevent the 
    optical photons from limiting simulations.  

    The actual speedup depends on your geometry and your effort in avoiding 
    geometry issues. 



.. comment

    https://inspirehep.net/authors/1016076

    from Tao : totals, include JUNO engagement : collab meetings, sim meetings
  
    from Tao : funding, mention applications of Ziyan and Liangjian


Outline
---------

.. class:: normal 

    I. (p2) Job responsibilities 
    II. Work status this year

      * (p5,6,7,8) Completion of research tasks [50%]
      * (p9) Personal research results (papers, patents, innovative technology development, awards, etc.) and funding
      * (p10,11) Academic exchanges, academic development plans [10% with above, excluding funding[10%]]
      * (p12) Public services [10%](on duty, graduate student assessment and interview, annual report writing, article review, etc.)
      * (p13) Other contributions (such as talent introduction, popular science, technology transfer and application, etc.)
 
    III. Existing problems
    IV. Work plan for next year



**I. Job responsibilities** : Dr Simon C. Blyth (D.Phil)
----------------------------------------------------------

.. class:: normal

   2024/09-2029/09 : *IHEP Associate Researcher*
    
     +-------------------------------------------------------------------------------+
     |                                                                               |
     | * :r:`Maximize Opticks benefits to JUNO and other experiments`                |
     | * Maximize GPU benefits to HEP projects able to innovate, eg CEPC             |
     |                                                                               |
     +-------------------------------------------------------------------------------+

.. class:: small 

   2021/02-2024/08 : *Senior Project Scientist JUNO, Visiting Researcher of IHEP* 
     JUNO+Opticks development 

     * Original development of shared GPU/CPU optimized CSG geometry model 
     * Enable state-of-the-art NVIDIA OptiX ray tracing of auto-translated detector geometry
     * Detailed JUNO+Opticks validations reveal steady stream of geometry and physics issues
 
       * fixed many issues, including unphysical PMT Optical Model 

   2018/05-11, 2019/03-12, 2020/04-12 : *Visiting Scientist, CAS Presidents International Fellowship Initiative* 
     * Generalizing Opticks to enable integration with JUNO simulation.
     * Enabled fully automated geometry management, via direct geometry translation.
 
   2013/08 - 2017/12 : *Researcher with National Taiwan University, Taipei based at NTU*
     Original research and development of GPU optical photon simulation framework, Opticks, 
     yielding unprecedented optical photon propagation performance.


.. s5_talk::

   Incase you are not familiar with me, I joined in September this year.
   But before then I have been working as a visitor to IHEP. 

   My job responsibilities are to ....

   These are showm here in the context of my prior work developing Opticks
   and integrating it with JUNO and other experiments


`(JUNO) Optical Photon Simulation Problem...`
---------------------------------------------------------

.. raw:: html

     <p style="position:fixed;top:100px;left:900px;font-size:40px;background-color:white;border:1px solid black;padding:5px;">
     Opticks solves this using GPU ray tracing via NVIDIA OptiX 
     </p>    

     <p style="margin-bottom:7cm;" />




.. sidebar:: :small:`Huge CPU Memory+Time Expense`

    .. class:: small

         **JUNO Muon Simulation Bottleneck**
           ~99% CPU time, memory constraints

         **Ray-Geometry intersection Dominates**
           simulation is not alone in this problem...

         **Optical photons : naturally parallel, simple :**
           * produced by Cherenkov+Scintillation 
           * yield only Photomultiplier hits


.. s5_talk::

   A muon travelling across the JUNO scintillator yields tens of millions 
   of optical photons, presenting memory and time challenges. 

   For every step of every photon intersects between rays representing the 
   photons and the geometry have to be found. 
   This ray tracing is what limits the simulation. 

   Another problem is the high memory requirements for all the photons

   * they cause high failure rates, forcing splitting of events. 
  
   These practical problems force analysis to make do with small samples 
   and limited different configurations.
   So they limits understanding of detector response.  

   Making simulation become unlimited by optical photons 
   enables larger simulation samples, greater understanding, 
   more fruit. 

   JUNO: optimum muon veto => maximum livetime => maximum impact



.. comment

   Optical photons are naturally parallel : they can be considered 
   to be produced only by two processes : Cherenkov and Scintillation and we
   are interested in photons that hit the PMTs.  

   These characteristics make it straightforward integrate an external optical
   simulation.
 
   * :b:`simulation unlimited by optical photons => greater understanding => more fruit` 
           



Geant4 + Opticks + NVIDIA OptiX : Hybrid Workflow
-------------------------------------------------------------

.. class:: small

    *Opticks* enables Geant4 based simulation to offload optical photon simulation to the GPU  

.. raw:: html

    <p style="margin-bottom:13cm;" />

.. class:: normal 

    **NVIDIA GPU ray tracing of billions[1] of rays per second applied to optical simulation**

.. class:: tiny

    [1] Actual performance depends on geometry and its modelling, optical simulation speedups > 1000x Geant4 have been measured  
 

.. s5_talk::

    How to use GPU ray tracing in simulation ? That is what Opticks does. 

    Opticks acts as a bridge between Geant4 on the CPU and NVIDIA OptiX GPU ray tracing 

    * at initialization Opticks translates the Geant4 model of 
      detector geometry into a suitable form and uploads that to the GPU

    * the Geant4 Cerenkov and Scintillation processes are modified 
      to prevent the normal CPU optical photon generation loop
      Instead the generation parameters or gensteps are collected  
      and then uploaded to the GPU for propagation at the end of each event

    * this means the optical photon simulation is entirely offloaded to the GPU, 
      with only the hits that are not culled by collection efficiency 
      requiring allocation of memory on the CPU
 

.. comment

   * "Release" build optimization separate from "Debug" 
   * OptiX tri intersect (RTX: in HW RT Cores)

   * separate GPU optical photon simulation impl
   * Geant4 geometry auto-translated into GPU form 
   * "genstep" photon gen parameters copied to GPU  


:small:`II. Work status this year : Completion of research tasks`
----------------------------------------------------------------------

.. sidebar:: :small:`Opticks Validation => JUNO issues`

    .. class:: small

          **Compare GPU+CPU optical simulation impl**
     
          * photon history Opticks:Geant4 chi2 comparison
          
            * reveals discrepant photon histories 
            * usually due to geometry problems

          **many tools + tests to find/investigate issues**

          * interactive standalone tests : fast dev cycle
          * interactive ray traced geometry rendering

            * 2D slices + 3D   


.. class:: small

    **JUNOSW + Opticks enhancements**

    2023/12 - 2024/02 : Opticks **Release Phase**
       * 1st JUNOSW+Opticks release /cvmfs/opticks.ihep.ac.cn
       * profiling machinery, CPU/GPU leak finding + fixing

    2024/03-11 : Opticks **Develop Phase** 
       * :b:`generalized geometry model, add triangulated` 
       * add interactive visualization, "fly" around detector 
       * integrate "list-node" reducing CSG tree depth 
       * developments to handle Geant4 11.2 CUDA 12.4 OptiX 8.0 

         * :r:`profit from 3rd gen NVIDIA RTX GPU ray tracing`  
      
    2024/04-11 : Opticks **Validate Phase**
       * :b:`reveals JUNO geometry issues => reimplement` 
       * Water pool poor modelling : simplify with heirarchy  
       * Acrylic sticks fastener : incorrect heirarchy   

    2024/10 : Opticks **Measure Phase** + Conferences
       * :r:`RTX 3rd gen vs 1st gen : 4x performance improvement`
       * report performance at CHEP 2024, nEXO optical workshop

    2024/11 : Entering **Release Phase** again
       * :b:`Now with full JUNO geometry (tri. for Torus.., listnode), Latest OptiX 8.0` 


.. s5_talk::

   Develop : Validate : Measure : Release

   Most of my time over the past few years has been 
   dedicated to finding and fixing issues with JUNO simulation,
   that were revealed by Opticks validations.  

   * most of the geometry bugs were from overcomplicated modelling 
   * the longest to fix bug was with the PMT optical model, 
     as required a full reimplementation taking more than 6 months 

     * that bug was a combination of geometry and physics that caused
       unphysical behavior of photons inside the PMT 

   JUNO+Opticks validations requires JUNO to not have bugs



:small:`Analytic + triangulated geometry` 
------------------------------------------------------

.. class:: small

   * default : analytic CSG solids
   * user can name solids for triangulation    

     * avoids issue with toruses + complex solids
     * BUT : approximate geometry 
     * triangulation from G4Polyhedron
     * config per-solid NumberOfRotationSteps by envvars
     * uses OptiX "built-in" triangle intersection

   :r:`NEW FEATURE`
       :r:`Integration of analytic + triangulated geometry`

.. s5_talk::

   Integration of analytic + triangulated geometry : NEW FEATURE 



:small:`2024 : JUNO+Opticks Geom Fixes`
------------------------------------------

.. comment

    for targetting seems need to use full page dimension half the actual dimension


.. raw:: html

    <p style="margin-bottom:-10mm;" />
    <p style="position:fixed;top:375px;left:10px;font-size:25px;background-color:white;border:1px solid black;padding:5px;">
    WaterPool HBeam Overlaps FIXED with simpler approach
    </p>
    <p style="position:fixed;top:275px;left:650px;font-size:25px;background-color:white;border:1px solid black;padding:5px;">
    FastenerAcrylic translated to "list-node"
    </p>
    <p style="position:fixed;top:625px;left:650px;font-size:25px;background-color:white;border:1px solid black;padding:5px;">
    Testing triangulated GuideTube + XJ + SJ solids
    </p>
    <p style="margin-bottom:20mm;" />
 

.. raw:: html

    <p style="margin-bottom:-15mm;" />

.. class:: small

   * Re-implemented WaterPool with hierarchy approach 

     * avoid : ~120 overlaps, complex CSG
     * enables translation to Opticks/GPU
  
   * FastenerAcrylic (590) working using "list-node" 

     * discontiguous => simple + fast 

   * GuideTube (39*2*2 = 156 G4Torus) 

     * torus intersect v.expensive on GPU => :r:`triangulate` 
     * adjust precision with NumberOfRotationSteps  

   * XJ + SJ solids (less numerous) 

     * many concident surfaces, testing :r:`triangulated` 



.. s5_talk::

    Klop




:i:`AB_Substamp_ALL_Etime_vs_Photon_rtx_gen1_gen3.png`
--------------------------------------------------------


.. raw:: html

     <p style="margin-bottom:45mm;" />


.. class:: tiny

    .. table:: Event Time(s) vs PH(M)
        :align: right 

        +---------+--------+-----+--------+
        | PH(M)   |   G1   | G3  | G1/G3  |
        +=========+========+=====+========+
        |  1      |  0.47  |0.14 |  3.28  |
        +---------+--------+-----+--------+
        | 10      |  0.44  |0.13 |  3.48  |
        +---------+--------+-----+--------+
        | 20      |  4.39  |1.10 |  3.99  |
        +---------+--------+-----+--------+
        | 30      |  8.87  |2.26 |  3.93  |
        +---------+--------+-----+--------+
        | 40      | 13.29  |3.38 |  3.93  |
        +---------+--------+-----+--------+
        | 50      | 18.13  |4.49 |  4.03  |
        +---------+--------+-----+--------+
        | 60      | 22.64  |5.70 |  3.97  |
        +---------+--------+-----+--------+
        | 70      | 27.31  |6.78 |  4.03  |
        +---------+--------+-----+--------+
        | 80      | 32.24  |7.99 |  4.03  |
        +---------+--------+-----+--------+
        | 90      | 37.92  |9.33 |  4.06  |
        +---------+--------+-----+--------+
        | 100     | 41.93  |10.42|  4.03  |
        +---------+--------+-----+--------+



.. raw:: html

    <p class="mymidleftbox">Optical simulation 4x faster 1st->3rd gen RTX,  (3rd gen, Ada : 100M photons simulated in 10 seconds) [TMM PMT model]</p>
    <pre>
   

.. s5_talk::

    GPU launch time vs number of photons becomes linear between 10M and 20M photons

    This is with JUNOs unusual PMT optical model where photons bounce around inside PMT and TMM




:small:`Personal research results : innovative technology development`
----------------------------------------------------------------------------

.. class:: normal 

    *Opticks* **Innovative Technology Developments**:

    * integration of state-of-the-art GPU ray tracing with Geant4 
    * open source analytic CSG implementation developed for GPU
    * shared analytic CPU/GPU geometry model

    **2024, extensions to these innovations:** 

    * triangulated + analytic geometry 
    * apply "listnode" reducing CSG tree depth for complex solids 
    * smoothly interactive ray traced visualization as "fly" around full detector geometries


:small:`Personal research results : papers`
----------------------------------------------

.. class:: normal

    **Conference Article**

    +-----------------------------------------------------------+
    | *Opticks: GPU Optical Photon Simulation via NVIDIA OptiX* |
    | EPJ Web of Conferences 295, 11014 (2024), Simon C. Blyth  |                       
    +-----------------------------------------------------------+

    **Journal Article**

    +-----------+----+
    | Daya Bay  |  4 |
    +-----------+----+
    | JUNO      |  1 | 
    +-----------+----+


:small:`Academic Exchanges : nEXO Workshop at McGill + CHEP 2024`
------------------------------------------------------------------------------


.. class:: small

    * 2024 October 25, **nEXO Light Simulation Workshop**,  McGill University, Montreal, Canada : *Invited guest speaker*  

      * demonstrated the performance and precision of Opticks, contrasted with Chroma
      * :r:`presentation + two days of extensive discussions with nEXO Simulation Group`
      * tentative plan to try Opticks with LoLX "Light-only Liquid Xenon experiment"


    * 2024 October 21, **CHEP 2024**, Krakow, Poland : *Opticks parallel presentation* 

      * presented progress with JUNO+Opticks
      * :b:`gained attention by demonstrating rapid performance gains with NVIDIA ray tracing` 
      * prominently reported in plenary simulation summary talk (Giacomo De Pietro)

.. class:: tiny

    https://indico.cern.ch/event/1338689/contributions/6182301/attachments/2954600/5194791/20241025_Track5_Summary.pdf 

.. raw:: html

   <p style="position:fixed;top:350px;left:900px;font-size:25px;background-color:white;border:1px solid black;padding:5px;">
     nEXO Light Simulation Workshop, McGill University, Montreal 
   </p>    

.. comment

    My visit to the CHEP conference in Krakow, Poland enabled me to present progress 
    with JUNO+Opticks to diverse colleagues from all over the world and 
    to discuss my work with others from CERN and the US who are also using GPUs 
    to accelerate simulation. My presentation demonstrated the ongoing strong improvement
    in ray tracing and simulation performance of NVIDIA RTX GPUs. 
    My work was prominently included in the summary session for the simulation track. 

    My visit to the nEXO optical photon simulation workshop at McGill University, Montreal, 
    Canada enabled me to present the case for the nEXO experiment to adopt the Opticks 
    simulation package to principal investigators, postdocs and students working 
    on nEXO optical simulations. The performance and precision enabled by Opticks 
    and demonstrated by my presentation and extensive discussions 
    was of great interest and resulted in a tentative plan to test Opticks 
    simulation with the LoLX "Light-only Liquid Xenon experiment" to evaluate 
    feasibility of adoption of Opticks by the nEXO experiment.   


.. comment

    ``McGill_nEXO_light_simulation_workshop_202410.png``
    ------------------------------------------------------



:small:`Academic Exchanges : Geant4 Technical Forum, Zhejiang Uni, IHEP EPD, JUNO` 
--------------------------------------------------------------------------------------

.. class:: small 

     * 2024 February 15, 60th **Geant4 Technical Forum**, CERN + Online
    
       * *Modified GEANT4 processes for JUNO Simulation*, presented by Cécile Jollet 
       * contributed details of boundary process customization for JUNO PMT Optical Model
     
     * 2024 February 27, **Zhejiang University Seminar**, Hangzhou

       * Opticks : Optical Photon Simulation via GPU Ray Tracing from NVIDIA® OptiX™
       * introductory seminar

     * 2024 April 18, **IHEP EPD Seminar**

       * *The Story of Opticks, applying NVIDIA OptiX GPU ray tracing to Optical Photon Simulation*
       * Three hour review seminar detailing the history of Opticks development 
    
     * 2024 **JUNO Meetings** 

       * Opticks reports at JUNO Collaboration meetings
       * reports at JUNO simulation meetings 


Funding
--------

.. class:: small

   **Funding : very strong potential, no progress yet**

   * Opticks benefits very clear 
   * principal of Opticks very easy to explain
   * innovative approach
   * ray tracing of interest to both science and tech communities 


Public services 
----------------

.. class:: small

   * Opticks:Geant4 photon history chi2 finds geometry bugs, then re-implement: 

     * Water pool and HBeam : CSG simplified using heirarchy, many overlaps avoided
     * Support stick fastener heirarchy corrected 

   * worked with JUNO+Opticks students/postdoc

     * Albert Zhou : helped to use JUNOSW+Opticks, he found Water pool bug 
     * Yuxiang Hu : integrated lookup based PMT model with Opticks, developed event visualization
     * Yuhan Ren : advised on PMT angular efficiency updates, reviewed: Neutrino 2024 abstract + poster
     * Diwash Ghimire : suggested geometry approach for Acrylic imperfections/repairs 

   * supported Opticks users from other experiments: 

     * Hans Wentzel : Fermilab Geant4 Group, Opticks updates for latest Geant4
     * Ilker Parmaksiz : NEXT-CRAB0 Prototype, University of Texas 

       * achieved 181x speedup relative to single-threaded Geant4
       * manuscript for EPJ under internal review  


.. class:: tiny

    NEXT : Neutrino Experiment with a Xenon TPC 

    NEXT-CRAB-0: A High Pressure Gaseous Xenon Time Projection Chamber with a Direct VUV Camera Based Readout



:small:`Other contributions (such as talent introduction, popular science, technology transfer and application, etc.)`
------------------------------------------------------------------------------------------------------------------------

.. class:: normal 

    **talent introduction, technology transfer : Yuxiang Hu**

    * worked closely with Yuxiang over past 2 years, focus:

      * software design : dependency control, testing + CUDA techniques  
 
    * 2024/9 : Yuxiang joined Huawei working on GPUs 

      * technology transfer IHEP => Huawei 



III. Existing problems 
-------------------------

.. class:: normal 

    * JUNO geometry + model continue to change, eg: 
   
      * Acrylic support stick fasteners geometry 
      * PMT angular efficiency
      * Acrylic repairs

      => requires work on both CPU and GPU sides 
 
    * :r:`chronic lack of manpower working on Opticks`



:small:`IV. Work plan for next year` 
-------------------------------------------------------

.. class:: normal 

   **Focus shift : adding features => easing usage**

   * automated validation/benchmark (continuous integration system) 
   * ease of use : examples, documentation, training
   * develop/propose Geant4 API for external photon propagation : :r:`avoid customized Geant4` 

   **Facilitate JUNOSW+Opticks Production Running** 

   * :b:`auto split/join event depending on GPU VRAM`
   * local GPU cluster production optimization
   * development to enable concurrent launching on multi-GPU machines
   * try distributed JUNOSW+Opticks production running  

   **CEPC**

   * see if Opticks can benefit CEPC calorimeter sim.+viz.
   * edit CEPC detector TDR offline software+computing section




.. comment

   * more frequent JUNO+Opticks releases  



.. comment

    :small:`Evaluation Estimate : (position started September 2nd 2024)`
    ----------------------------------------------------------------------

    .. class:: small

        +-------------------+-------------------------------------------------------------------------------+---------+--------------------+
        |                   |  Review Project                                                               | Est.    |  Note              | 
        +===================+===============================================================================+=========+====================+
        |                   |                                                                               |         |                    |
        |                   |                                                                               |         |                    |
        |                   |  Mission Completion (50%)                                                     |   5.0   |                    |
        |                   |                                                                               |         |                    |
        |   Mission         |                                                                               |         |                    |
        |   Completed       +-------------------------------------------------------------------------------+---------+--------------------+
        |   (80%)           |   Academic development, academic exchanges, papers (10%)                      |   5.0   |                    |
        |                   +-------------------------------------------------------------------------------+---------+--------------------+
        |                   |   Strive for projects and funding (10%)                                       |   1.0   | [1,HELP NEEDED]    |
        |                   +-------------------------------------------------------------------------------+---------+--------------------+
        |                   |   Public services (10%)                                                       |   5.0   |                    |
        +-------------------+-------------------------------------------------------------------------------+---------+--------------------+
        |   Professional    |   Scientific research ability, academic organization ability, work initiative |   5.0   |                    |
        |   Quality         |   and creativity, cooperative spirit                                          |         |                    |
        +-------------------+-------------------------------------------------------------------------------+---------+--------------------+


