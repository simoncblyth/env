

.. comment 

.. raw:: html

    <style type="text/css">
        span.alarm { color: red; } 
        span.warn { color: orange; } 
        span.ok { color: green; } 
        span.i { display: none; } 
        pre.sliteral { class:"literal-block small"; }   
        pre.mypre {
             display: block;
             font-family: monospace;
             font-size: 20px;
             white-space: pre;
             margin: 1em 0;
        }

        pre.myfoot {
             display: block;
             font-family: monospace;
             font-size: 18px;
             white-space: pre;
             color: white;
             position: absolute; top:86%; left:4%; width:50%; height:10% ;
        }

        div.mytitle {
             font-size: 20px;
             color: black;
             position: absolute; top:0%; left:5%; width:90%; height:10% ;
        }

        div.mycredit {
             font-size: 20px;
             color: black;
             position: absolute; top:90%; left:5%; width:50%; height:10% ;
        }





    </style>

.. role:: i 
.. role:: alarm
.. role:: warn
.. role:: ok
.. role:: sliteral
.. role:: mypre 
.. role:: myfoot
.. role:: mytitle


.. include:: <s5defs.txt>

.. s5_background_image::

    #
    # slide titles and background image urls, 
    # including server relative urls like /env/geant4/geometry/collada/daeview/20140419-170713.png
    # and protocol relative urls like //localhost/env/test/LANS_AD3_CoverGas_Humidity.png
    #
    # NB1 slide titles here must match those in body precisely, 
    # NB2 also ensure all slide titles are unique
    #
    #slide0
    #/env/geant4/geometry/collada/g4daeview/20140419-170713.png auto_auto 0px_0px
    #/env/geant4/geometry/collada/g4daeview/20140419-170713-1024x768.png auto_auto 0px_0px
    #
    #   wide targetting 1280x720
    #   
    #
    slide0
    /env/graphics/ggeoview/jpmt-inside-wide_crop.png 1280px_720px

    g4daeview.py : Fast OpenGL 3D viewer for G4DAE files
    /env/geant4/geometry/collada/g4daeview/20140419-170713.png

    Cerenkov Photons Simulation - Top View
    /env/geant4/geometry/collada/g4daeview/20141224-115923.png

    Cerenkov Photons Simulation - Side View
    /env/geant4/geometry/collada/g4daeview/20141224-115935.png

    Scintillation Photons Simulation - Top View
    /env/geant4/geometry/collada/g4daeview/20141224-121444.png

    Scintillation Photons Simulation - Side View
    /env/geant4/geometry/collada/g4daeview/20141224-121435.png

    Standard Geant4 Workflow
    /env/keynotefigs/G4DAEChroma/G4DAEChroma.001.png

    External Photon Simulation Workflow
    /env/keynotefigs/G4DAEChroma/G4DAEChroma.002.png

    GGeoView
    /env/graphics/ggeoview/ggeoview-cerenkov-001.png 1047px_795px

    GGeoView M1 Points
    /env/graphics/ggeoview/ggeoview-scintillation-points-mat1.png 1435px_848px

    GGeoView Flag Selection 
    /env/graphics/ggeoview/ggeoview-scintillation-flag-seq-select.png 1436px_842px

    GGeoView Cerenkov Geom M1
    /env/graphics/ggeoview/ggeoview-cerenkov-m1-geom.png 1416px_845px
  
    Detecting Neutrinos via Optical Photons 1
    /env/presentation/dayabay-principal_half.png 1417px_830px 

    Detecting Neutrinos via Optical Photons 2
    /env/presentation/dayabay-principal_half.png 1417px_830px 
 
    JPMT Inside Wide 
    /env/graphics/ggeoview/jpmt-inside-wide_half.png 1432px_844px

    JPMT Wide
    /env/graphics/ggeoview/jpmt-wide_half.png 1409px_836px
  
    JPMT Headview
    /env/graphics/ggeoview/jpmt-headview_half.png 1308px_783px
 
    JPMT Backview
    /env/graphics/ggeoview/jpmt-backview_half.png 1149px_794px 
 
    JPMT Approach 
    /env/graphics/ggeoview/jpmt-approach_half.png 1431px_839px

    JPMT Arrival 
    /env/graphics/ggeoview/jpmt-arrival_half.png 1427px_841px 
 
    But, there is a problem...
    /env/graphics/ggeoview/jpmt-before-contact_half.png 1430px_844px 

    JPMT Before Contact 2
    /env/graphics/ggeoview/jpmt-before-contact_half.png 1430px_844px 

    JPMT Before Contact 3
    /env/graphics/ggeoview/jpmt-before-contact_half.png 1430px_844px 

 
    JPMT After Contact 
    /env/graphics/ggeoview/jpmt-after-contact_half.png 1425px_840px 
  
    JPMT Inside Outside 
    /env/graphics/ggeoview/jpmt-inside-outside_half.png 1401px_842px

    NVIDIA OptiX In Action
    /env/presentation/optix-in-action_half.png 966px_646px 100px_50px

    PmtInBox approach 1
    /env/graphics/ggeoview/PmtInBox-approach.png 1069px_769px 

    PmtInBox approach 2
    /env/graphics/ggeoview/PmtInBox-approach.png 1069px_769px 

    PmtInBox after 1
    /env/graphics/ggeoview/PmtInBox-after.png 1057px_760px 

    PmtInBox after 2
    /env/graphics/ggeoview/PmtInBox-after.png 1057px_760px 

    Daya Bay PMT Wall Photo 1
    /env/presentation/gtc2016/dyb-pmt-wall-photo.png 1329px_798px  

    Daya Bay PMT Wall Photo 2
    /env/presentation/gtc2016/dyb-pmt-wall-photo.png 1329px_798px  

    Super-Kamiokande PMTs Not 16:9 
    /env/presentation/gtc2016/sk-PH20-water-withboat-apr23-wm.png 1181px_771px

    Super-Kamiokande PMTs 1
    /env/presentation/PH20-water-withboat-apr23-wm_crop.png 1280px_720px

    Super-Kamiokande PMTs 2
    /env/presentation/PH20-water-withboat-apr23-wm_crop.png 1280px_720px

    Optical Photons
    /env/presentation/newtons-opticks.png 374px_684px 800px_0px

    Hamamatsu Photomultiplier Tubes (PMTs)
    /env/presentation/hamamatsu-pmt.png 1099px_734px

    Photomultiplier Tube Operation
    /env/presentation/hamamatsu-pmt.png 1099px_734px

    Jiangmen Underground Neutrino Observatory (JUNO) 
    /env/presentation/juno-schematic-5.png 1391px_734px

    Jiangmen Underground Neutrino Observatory, Goals
    /env/presentation/juno-schematic-5.png 1391px_734px


    Dayabay Reactor Neutrino Expt, Far Site
    /env/presentation/DybFar_crop.png 1280px_720px

    Daya Bay Far Site 2
    /env/presentation/DybFar_crop.png 1280px_720px

    Geant4 : Monte Carlo Simulation Toolkit 
    /env/presentation/g4-hep.png 1025px_621px 100px_100px 

    "Seeing" neutrinos via scintillation + Cherenkov light
    /env/presentation/cherenkov.png 316px_203px 850px_400px


 
.. comment 

    GGeoView image is 2094x1590 1047x795

    GGeoView M1 Points is 2870x1696  1435x848

    GGeoView Flag Selection 2872x1684 1436x842

    GGeoView Cerenkov Geom M1 2832x1690 1416x845


    Generated Scintillation Photons GPU cf Geant4
    /env/g4dae/generated_scintillation_time_wavelength.png

    G4/DetSim Generated Cerenkov Wavelength
    /env/g4dae/g4_cerenkov_wavelength.png



.. comment

    Placeholder

    jpmt-after-contact.png 2850px_1680px
    jpmt-approach.png 2862px_1678px
    jpmt-arrival.png 2854px_1682px
    jpmt-backview.png 2298px_1588px
    jpmt-before-contact.png 2860px_1688px
    jpmt-headview.png 2616px_1566px
    jpmt-inside-outside.png 2802px_1684px
    jpmt-wide.png 2818px_1672px



===================================================================================
:i:`Opticks : Optical Photon Simulation for Particle Physics with NVIDIA OptiX` 
===================================================================================


.. raw:: html

    <div class="mytitle">
    <h1 style="background-color:lightgrey"> <i>Opticks</i> : Optical Photon Simulation for Particle Physics with NVIDIA® OptiX™ </h1>
    </div>

    <div class="mycredit">
    <h2 style="background-color:lightgrey"> Simon C Blyth, National Taiwan University &mdash;  GTC 2016 </h2>
    </div>



.. comment

    **1704** 
           Sir Isaac Newton published *Opticks* 

    **2008** 
           NVIDIA® begins OptiX™ development

    **2015** 
           *Opticks* development based on OptiX™ begins 


Optical Photons 
------------------

Optical Photons crucial to Particle Physics Experiments:

* **Neutrino detectors**
* Proton Decay Search 
* Particle Identification

"Seeing" Neutrino interactions:

* large optically transparent target 

  * eg water, ice, scintillators
 
* detectors sensitive to single photons

  * Photomultiplier Tubes (PMTs)


Sir Isaac Newton published *Opticks* in 1704



``Hamamatsu Photomultiplier Tubes (PMTs)``
--------------------------------------------


``Photomultiplier Tube Operation``
--------------------------------------------


.. image:: /env/presentation/1px.png
   :height: 150px

.. figure:: /env/presentation/pmt-schematic.png
   :width: 700px
   :align: center   

   ``Single photoelectron amplified by ~10 dynodes to yield measurable signal`` 



:i:`Super-Kamiokande PMTs 1`
----------------------------------------------------------------------

.. raw:: html

    <pre class="myfoot">
    © Kamioka Observatory, ICRR(Institute for Cosmic Ray Research), The University of Tokyo.
    </pre>




:i:`Super-Kamiokande PMTs 2`
----------------------------------------------------------------------

.. raw:: html

    <pre class="myfoot">
    © Kamioka Observatory, ICRR(Institute for Cosmic Ray Research), The University of Tokyo.
    </pre>


.. sidebar:: Super-Kamiokande Water Cerenkov Detector

    50,000 tons ultra pure water,
    13,000 Photomultiplier Tubes, 
    1,000 meter underground.

    * solar neutrinos, fusion
    * atmospheric neutrinos, cosmics
    * accelerator neutrinos, beams 
    * reactor neutrinos, fission
    * supernova neutrinos (SN 1987A)

    .. class:: tiny

        http://www-sk.icrr.u-tokyo.ac.jp/sk/index-e.html


:blue:`Jiangmen Underground Neutrino Observatory (JUNO)` 
------------------------------------------------------------

:blue:`Jiangmen Underground Neutrino Observatory, Goals` 
------------------------------------------------------------

.. sidebar:: Under Construction

    .. class:: small

        20,000 ton liquid scintillator, 700 m underground, 
        17,000 20" PMTs, 34,000 3" PMTs,
        unprecedented energy resolution: 3% (at 1 Mev). Goals:

        * **Determine neutrino mass heirarchy** from 
          energy spectrum of reactor electron antineutrinos 
          at ~53km from reactors.

        * Measure oscillation parameters

        Study:

        * atmospheric neutrinos
        * solar neutrinos
        * geo-neutrinos
        * supernova neutrinos
        * exotic searches

    .. class:: tiny

        http://juno.ihep.ac.cn






``Dayabay Reactor Neutrino Expt, Far Site``
----------------------------------------------------

:i:`Daya Bay Far Site 2`
-------------------------

.. image:: /env/presentation/ad3.png
   :width: 662px
   :height: 696px 



:i:`Daya Bay PMT Wall Photo 1`
----------------------------------------------------------------------

.. raw:: html

    <pre class="myfoot">
    © 2010 The Regents of the University of California, through the Lawrence Berkeley National Laboratory
    </pre>


:i:`Daya Bay PMT Wall Photo 2`
----------------------------------------------------------------------


.. sidebar:: Dayabay Reactor Neutrino Experiment

    Eight Antineutrino Detectors (AD) in 3 halls, 
    within 1.9 km of six nuclear reactors, in southern China. 
    Each AD:

    * 20 tons of liquid scintillator
    * 192 8 inch PMTs


    Most precise measurements of:

    * neutrino oscillation
    * reactor antineutrino spectrum

    .. class:: tiny

        http://dayawane.ihep.ac.cn


.. raw:: html

    <pre class="myfoot">
    © 2010 The Regents of the University of California, through the Lawrence Berkeley National Laboratory
    </pre>





.. comment

    .. image:: /env/presentation/ibd-prompt-delayed.png  
       :width: 1033px
       :height: 228px 

    .. figure:: /env/presentation/cherenkov.png
       :width: 632px
       :height: 406px




"Seeing" neutrinos via scintillation + Cherenkov light
----------------------------------------------------------

.. class:: small

   Antineutrinos react with protons in liquid scintillator yielding e+ and gammas. 
   Particle energy absorbed by the scintillator is re-emitted as **optical photons**.
   Dayabay uses 0.1% Gadolinium doped liquid scintillator.

.. image:: /env/presentation/ibd-prompt-delayed.png  
   :height: 200px 

.. class:: small

   **Cherenkov light** 
 
   * emitted by charged particles with velocity > materials speed of light
   * occurs in all transparent materials eg water, ice, scintillator


   **Optical Photon Propagation Model**

   Detailed **optical photon simulation** critical to detector design, achieving goals.



Geant4 : Monte Carlo Simulation Toolkit 
-------------------------------------------

.. sidebar:: Leading in Particle Physics

   .. class:: small
        
       **Geant4** simulates particles travelling through matter, 
       with applications in high energy, nuclear and accelerator
       physics, medical imaging, radiotherapy and space science. 
       20 year history, ubiquitous in physics experiments.

       **Simulation** essential for:

       * detector design/optimization 
       * reconstruction algorithm development
       * reconstruction efficiency estimates

       **Geant4 Model**

       * geometry : **CSG tree of solids**
       * particles : tracks 
       * processes : nuclear, EM, weak, **optical**
 

   .. class:: tiny

      https://geant4.web.cern.ch
 



``But, there is a problem...``
---------------------------------

:i:`JPMT Before Contact 2`
--------------------------


.. sidebar:: Optical Photon Simulation Problem

    .. class:: small
        
         Cosmic muons can yield many millions
         of optical photons in Daya Bay (even more in JUNO).
         Optical photon propagation dominates 
         *Geant4* simulation time ~95% for Daya Bay.

         Cosmic Muon Sample sizes severely limited by 
         CPU time and memory practicalities.

         **Hybrid Solution : Geant4 + Opticks** 

         External propagation possible as optical photons 
         are isolated in simulation chain.
         
         * produced by Cerenkov/Scintillation
         * yield only PMT hits




:small:`Parallels between Realistic Image Synthesis and Optical Simulation`
-------------------------------------------------------------------------------

.. sidebar:: OptiX *Glass* Sample App

    .. image:: /env/optix/samples/optix-ray-tracing-glasses.png 
       :width: 450px
       :align: right

    .. class:: tiny

        http://on-demand.gputechconf.com/siggraph/2013/presentation/SG3106-Building-Ray-Tracing-Applications-OptiX.pdf


.. class:: small

    Realistic image synthesis and optical photon simulation 
    have the same rate determining step: :red:`geometry intersection`. 

    Tools developed for fast ray tracing can be a huge benefit to optical photon simulation. 
   

    NVIDIA OptiX benefits:
 
    * ray tracing framework: **flexible, low level**

    * state-of-the-art GPU accelerated intersection 

    * regular releases: improvements, new GPU tuning

    * shared C++/CUDA context eases development 

    * :red:`NVIDIA expertise on efficient GPU/multi-GPU usage` 

    * linear performance scaling with CUDA cores across multiple GPUs






:small:`Brief History of GPU Optical Photon Simulation Development`
----------------------------------------------------------------------

.. sidebar:: Aim of Opticks  

    .. class:: small
    
         *Opticks* aims to replace *Geant4* optical photon
         propagation with an equivalent and drastically 
         faster GPU implementation. 

         This requires bridging of geometry and event data.
         between *Geant4* and *Opticks* 
        
         **Side Benefit : Performant Visualization**

         Migrating Geant4 C++ CSG tree geometry to the GPU 
         enables unprecedented visualizations.  
       

.. class:: small

   **2013(Aug-)** [liberate geometry from *Geant4*]

   * Develop *G4DAE* geometry exporter that writes tesselated COLLADA 3D files, 
     including all material and surface properties.

   **2014** [integrate geometry/event data with *Chroma* [1]]

   * Integrate *G4DAE* geometries with *Chroma* 
   * Develop runtime event data bridge
   * GPU Cerenkov/Scintillation photon generation

   **2015** [replace *Chroma* with *Opticks*]

   * Develop *Opticks* with *NVIDIA OptiX* ray tracing 
   * *Opticks/Geant4* matched for simple geometries 
   * Speedup factor of 200x with a mobile GPU

   **2016** [*Opticks* validation against *Geant4*]

   * Achieve match for single PMT 


.. class:: tiny

   [1] http://chroma.bitbucket.org Developed by Stan Seibert, University of Pennsylvania



:small:`Introducing Opticks : Recreating Geant4 "Context" on GPU`
------------------------------------------------------------------

.. sidebar:: Opticks ~15 C++ Pkgs 

      .. class:: small

          Organized by dependencies

          * :red:`Recreates Geant4 context on GPU`
          * :blue:`Optical simulation by OptiX programs` 
          * :blue:`Photon Indexing by Thrust`

          Interop between OpenGL/OptiX/Thrust/CUDA  

          * :blue:`shared GPU buffers, efficient visualization`

          C++ code but NumPy analysis/debugging by using 
          :red:`.npy serialization` for all buffers 

          Externals: 

          * Boost + Asio-ZMQ, ZMQ
          * CUDA 7.0, Thrust 1.8
          * OptiX 3.8, OpenGL 4.1 
          * OpenMesh 4.1, ImGUI  


.. class:: small

   **Basis packages**

   * *Opticks* : definitions, configuration
   * *NPY* : array handling, persistency, py-analysis
   * *NumpyServer* : network IO of *NPY* arrays

   **Geometry packages** 

   * *AssimpWrap* : G4DAE loading with Assimp fork
   * *GGeo* : preparing geometry for GPU
   * *OpenMeshRap* : mesh fixing 

   **GPU library interface packages** 

   * *OpticksOp* : high level GPU control 
   * *OptiXRap* : OptiX control
   * *ThrustRap* : photon indexing
   * *CUDAWrap* : persist cuRAND state 
   * *OGLWrap* : OpenGL visualization

   **Main packages**
   
   * *GGeoView* : visualization main
   * *CFG4* : Geant4 10.2 comparison main



:small:`Geometry Modelling : Tesselated vs Analytic Photomultiplier Tubes`
----------------------------------------------------------------------------
 
.. image:: /env/graphics/ggeoview/dpib-triangulated-pmt.png
   :width: 550px
   :align: left 

.. image:: /env/nuwa/detdesc/pmt/hemi-pmt-analytic-near-clipped.png
   :width: 550px
   :align: right

.. image:: /env/presentation/1px.png
   :width: 1000px
   :height: 1px
   :align: center


.. class:: small

   Analytic : more realistic, faster, less memory, **much more effort**

   For Dayabay PMT:

   * partition CSG solids into 12 **single primitive** parts (instead of 2928 triangles)
   * splitting at geometrical intersections avoids implementing general CSG boolean handling
   * geometry provided to OptiX in form of ray intersection code


:small:`Tesselated Photomultiplier : unrealistic disco ball effect`
---------------------------------------------------------------------

.. image:: /env/graphics/ggeoview/dpib-test-disco-ball.png
   :width: 900px
   :align: center


:small:`Analytic PMTs together with triangulated geometry`
----------------------------------------------------------------

.. class:: small

   Starting from convenient tesselated geometry, implement analytic geometry for 
   critical parts in primary optical path, to allow very close *Geant4/Opticks* match.  

.. image:: /env/nuwa/detdesc/pmt/analytic-pmt-optix-geometry.png
   :width: 800px
   :align: center


:small:`Validation : Opticks/Geant4 Matching using Dynamic Geometry`
---------------------------------------------------------------------


.. sidebar:: *CfG4* package 

   .. class:: small
     
      * Records **G4** steps in **Opticks** format 
      * load into **Opticks** for visualization 

.. class:: small

   Commandline parsed into geometry. Shapes require: 
   
   * **OptiX**: analytic intersection code 
   * **OpenGL**: tesselation for visualization
   * **Geant4**: geometry construction in *CfG4* 
   
   ===========================================  =================  =================  ================== 
     Shape                                        OptiX              OpenGL             Geant4
   ===========================================  =================  =================  ================== 
     **sphere**                                    Y                  Y                   Y
     box                                           Y                  Y                   Y
     prism                                         Y                  Y                   
     convex lens                                   Y                  Y                            
     **Dayabay PMT**                               Y                  Y                   Y    
   ===========================================  =================  =================  ================== 


:small:`Multiple Rainbows from a Single Drop of Water`
--------------------------------------------------------

.. image:: /env/presentation/rainbow-mechanism.png
   :width: 900px
   :align: center

.. class:: small

   Caustic bunching at least deviation causes rainbow 

   (a) Primary bow, single reflection : ray f at bow angle
   (b) Secondary bow, double reflection : ray g at bow angle
   (c) Deviation angles 0:180 degrees hemisphere opposite to incident rays

.. class:: tiny

   Jearl D. Walker, 1975, Multiple rainbows from single drops of water and other liquids
   http://patarnott.com/atms749/pdf/MultipleRainbowsSingleDrops.pdf


:small:`Disc beam 1M Photons incident on Water Sphere (S-Pol)`
----------------------------------------------------------------

.. class:: tiny

    Photons shown by lines with color representing polarization direction. S-Polarized (perpendicular to plane of incidence) 
    intersection by disc radially directed polarization. Geodesic icosahedron tesselation just for OpenGL visualization, 
    actual OptiX geometry is perfect sphere.

.. image:: /env/graphics/ggeoview/rainbow-spol-disc-incident-sphere.png
   :width: 900px
   :align: center


:small:`Opticks/Geant4 Rainbow Step Sequence Comparison`
---------------------------------------------------------------------

.. class:: small

   * BT/BR: boundary transmit/reflect
   * TO/SC/SA: torch/scatter/surface absorb

   **1M flag sequences indexed using CUDA Thrust, 0.040 s**

.. raw:: html

    <pre class="mypre">
     64-bit uint  Opticks    Geant4    chi2                                      (tag:5,-5)   

            8ccd   819160    819654    0.15  [4 ] TO BT BT SA                    (cross droplet) 
             8bd   102087    101615    1.09  [3 ] TO BR SA                       (external reflect)
           8cbcd    61869     61890    0.00  [5 ] TO BT BR BT SA                 (bow 1)
          8cbbcd     9618      9577    0.09  [6 ] TO BT BR BR BT SA              (bow 2)
         8cbbbcd     2604      2687    1.30  [7 ] TO BT BR BR BR BT SA           (bow 3)
        8cbbbbcd     1056      1030    0.32  [8 ] TO BT BR BR BR BR BT SA        (bow 4)
           86ccd     1014      1000    0.10  [5 ] TO BT BT SC SA
       8cbbbbbcd      472       516    1.96  [9 ] TO BT BR BR BR BR BR BT SA     (bow 5)
             86d      498       473    0.64  [3 ] TO SC SA
      bbbbbbbbcd      304       294    0.17  [10] TO BT BR BR BR BR BR BR BR BR  (bow 8+ truncated)
      8cbbbbbbcd      272       247    1.20  [10] TO BT BR BR BR BR BR BR BT SA  (bow 6)
      cbbbbbbbcd      183       161    1.41  [10] TO BT BR BR BR BR BR BR BR BT  (bow 7 truncated) 
             4cd      161       139    1.61  [3 ] TO BT AB
           8c6cd      153       106    8.53  [5 ] TO BT SC BT SA
            86bd      138       142    0.06  [4 ] TO BR SC SA
            4ccd      100       117    1.33  [4 ] TO BT BT AB
    </pre>



:small:`1M Rainbow S-Polarized, Comparison Opticks/Geant4`
------------------------------------------------------------

.. class:: tiny

   Deviation angle(degrees) of 1M parallel monochromatic photons in disc shaped beam incident on water sphere.
   Numbered bands are visible range expectations of first 11 rainbows.
   S-Polarized intersection (E field perpendicular to plane of incidence) arranged by directing polarization radially.

.. image:: /env/optix/cfg4/rainbow-cfg4-spol.png
   :width: 800px
   :align: center




:i:`PmtInBox approach 1`
---------------------------------


:i:`PmtInBox approach 2`
---------------------------------

.. sidebar:: PmtInBox test geometry 

    .. class:: small
    
         0.5M photons from disc source incident on Dayabay PMT in MineralOil, 
         box inner surface perfect absorber.
         Colors represent the polarization direction (adhoc).

         Composited image:

         * OptiX raytrace of simulated analytic geometry
         * OpenGL photon step representation, from shared
           OpenGL/OptiX buffer

         Composited using Z-depth calulated for each raytrace pixel. 



:i:`PmtInBox after 1`
---------------------------------


:i:`PmtInBox after 2`
---------------------------------

.. sidebar:: PmtInBox at 1.8ns 

    .. class:: small
    
         GGeoView provides interactive photon selection 
         by history or material flag sequences, such as:

         TO BT SA         
              surface absorbed without detection  

         TO BT SD         
              surface detected on photocathode

         TO BT BT SA       
              edge Pyrex crossers (outer ring) 

         TO AB             
              bulk absorbed 

         TO BR SA          
              reflected from Pyrex   

         TO BT BR BR BT SA 
              double Pyrex reflections (inner ring)


         TO/AB/BT/BR
               torch/bulk absorb/boundary transmit/reflect

         Geant4 (CfG4) propagated events can be visualized by loading
         into GGeoView.




:small:`PMT Opticks/Geant4 Step Sequence Comparison`
---------------------------------------------------------------------

.. class:: small

   **Good agreement reached**, after several fixes: geometry, TIR, GROUPVEL, ...

   * nearly identical geometries (no triangulation error)  


.. raw:: html

    <pre class="mypre">
         64-bit uint  Opticks   Geant4   chi2    (tag:4,-4)

                 8cd   340271   340273   0.00  [3 ] TO BT SA
                 7cd   107598   107251   0.56  [3 ] TO BT SD
                8ccd    23217    23260   0.04  [4 ] TO BT BT SA
                  4d    18866    19048   0.87  [2 ] TO AB
                 86d     3179     3133   0.34  [3 ] TO SC SA
                 4cd     2204     2249   0.45  [3 ] TO BT AB
                4ccd     1696     1732   0.38  [4 ] TO BT BT AB
                 8bd     1446     1455   0.03  [3 ] TO BR SA
                8c6d      382      424   2.19  [4 ] TO SC BT SA
               86ccd      260      260   0.00  [5 ] TO BT BT SC SA
                 46d      197      215   0.79  [3 ] TO SC AB
              8cbbcd      190      213   1.31  [6 ] TO BT BR BR BT SA
                 4bd      132      125   0.19  [3 ] TO BR AB
                7c6d      111      132   1.81  [4 ] TO SC BT SD
                866d       35       38   0.12  [4 ] TO SC SC SA
               8cc6d       31       29   0.07  [5 ] TO SC BT BT SA
               ...
                       500000   500000   0.89 
    </pre>


:small:`PMT Opticks/Geant4 step comparison TO BT [SD] : position(xyz), time(t)`
-------------------------------------------------------------------------------------

.. image:: /env/numerics/npy/PmtInBox_TOBTSD_xyzt.png 
   :width: 900px
   :align: center


:small:`PMT Opticks/Geant4 step comparison TO BT [SD] : polarization(abc), radius(r)`
-----------------------------------------------------------------------------------------

.. image:: /env/numerics/npy/PmtInBox_TOBTSD_abcr.png
   :width: 900px
   :align: center


:small:`PmtInBox Opticks/Geant4 Chi2/ndf distribution comparisons`
---------------------------------------------------------------------------------------

.. class:: small

    **no large discrepancies**, small chi2/ndf in single/few bin cases  

.. class:: tiny

    XYZ position, T time, ABC polarization, R xy-radius

    ============================== ===== ===== ===== ===== ===== ===== ===== ===== 
    4/PmtInBox/torch :             X     Y     Z     T     A     B     C     R     
    ============================== ===== ===== ===== ===== ===== ===== ===== ===== 
    340271/340273  :  [TO] BT SA    1.15  1.00  0.00  0.00  1.06  1.03  0.00  1.21 
    340271/340273  :  TO [BT] SA    1.15  1.00  1.06  0.91  1.06  1.03  0.00  1.21 
    340271/340273  :  TO BT [SA]    0.97  1.02  1.05  0.99  1.06  1.03  0.00  1.29 
    ------------------------------ ----- ----- ----- ----- ----- ----- ----- ----- 
    107598/107251  :  [TO] BT SD    0.91  0.73  0.56  0.56  0.98  1.09  0.56  0.94 
    107598/107251  :  TO [BT] SD    0.91  0.73  0.81  0.93  0.98  1.09  0.56  0.94 
    107598/107251  :  TO BT [SD]    0.99  0.83  0.97  0.99  0.98  1.09  0.56  0.93 
    ------------------------------ ----- ----- ----- ----- ----- ----- ----- ----- 
    23217/23260  :  [TO] BT BT SA   0.94  0.82  0.04  0.04  0.97  0.89  0.04  0.57 
    23217/23260  :  TO [BT] BT SA   0.94  0.82  0.70  0.50  0.97  0.89  0.04  0.57 
    23217/23260  :  TO BT [BT] SA   0.91  0.94  0.43  0.60  0.97  0.89  0.04  0.05 
    23217/23260  :  TO BT BT [SA]   0.94  0.88  0.04  0.35  0.97  0.89  0.04  0.72 
    ------------------------------ ----- ----- ----- ----- ----- ----- ----- ----- 
    18866/19048  :  [TO] AB         0.99  1.10  0.87  0.87  0.85  0.84  0.87  1.00 
    18866/19048  :  TO [AB]         0.99  1.10  0.93  0.92  0.85  0.84  0.87  1.00 
    ------------------------------ ----- ----- ----- ----- ----- ----- ----- ----- 
    3179/3133  :  [TO] SC SA        1.07  0.83  0.34  0.34  0.86  0.96  0.34  0.73 
    3179/3133  :  TO [SC] SA        1.07  0.83  0.98  1.05  0.98  1.06  0.98  0.73 
    3179/3133  :  TO SC [SA]        0.96  1.04  0.93  0.97  0.98  1.06  0.98  1.10 
    ------------------------------ ----- ----- ----- ----- ----- ----- ----- ----- 
    2204/2249  :  [TO] BT AB        0.85  1.04  0.45  0.45  0.99  0.92  0.45  1.06 
    2204/2249  :  TO [BT] AB        0.85  1.04  0.95  0.88  0.99  0.92  0.45  1.06 
    2204/2249  :  TO BT [AB]        0.98  0.94  1.01  1.00  0.99  0.92  0.45  0.90 
    ------------------------------ ----- ----- ----- ----- ----- ----- ----- ----- 
    1696/1732  :  [TO] BT BT AB     1.05  0.85  0.38  0.38  0.86  1.09  0.38  0.26 
    1696/1732  :  TO [BT] BT AB     1.05  0.85  1.48  1.28  0.86  1.09  0.38  0.26 
    1696/1732  :  TO BT [BT] AB     0.99  0.86  1.17  1.40  0.86  1.09  0.38  0.86 
    1696/1732  :  TO BT BT [AB]     1.15  0.88  1.08  1.06  0.86  1.09  0.38  0.79 
    ------------------------------ ----- ----- ----- ----- ----- ----- ----- ----- 
    1446/1455  :  [TO] BR SA        1.21  0.94  0.03  0.03  0.90  0.87  0.03  1.09 
    1446/1455  :  TO [BR] SA        1.21  0.94  1.02  1.01  0.90  0.87  0.03  1.09 
    1446/1455  :  TO BR [SA]        1.00  0.93  0.97  0.99  0.90  0.87  0.03  1.04 
    ============================== ===== ===== ===== ===== ===== ===== ===== ===== 








:small:`Photon Propagation Times Geant4 cf Opticks`
----------------------------------------------------------

.. image:: /env/optix/cfg4/PmtInBox-cfg4-2.png
   :width: 800px
   :align: center

.. class:: small

    ====================  =================  =================  ================== 
     Test                  Geant4 10.2       Opticks Interop     Opticks Compute      
    ====================  =================  =================  ================== 
     Rainbow 1M(S)           56 s               1.62 s            0.28 s         
     Rainbow 1M(P)           58 s               1.71 s            0.25 s         
     **PmtInBox 0.5M**       **41 s**           0.81 s            **0.15 s** 
    ====================  =================  =================  ================== 

.. class:: small

    * **Opticks > 200X Geant4** with only 384 core mobile GPU
    * multi-GPU workstation up to 20x more cores 
    * :red:`photon propagation time will become effectively zero`

.. class:: small
   
    * **Interop** uses OpenGL buffers allowing visualization, **Compute** uses OptiX buffers
    * **Interop/Compute** : perfectly identical results, monitored by digest
    * **Compute** (and **G4**) propagations visualized by loading into **Interop** viewer


:small:`Summary`
-----------------------------

.. sidebar:: Opticks Overview

   .. class:: small
     
      * **200x Geant4** with mobile GPU
      * **> 1000x** expected (workstation GPUs) 
      * :red:`photon propagation time --> zero`
      * :blue:`analytic geometry --> precise G4 matching`

.. class:: small

   **Opticks Transition Complete**

   * devised mesh fixing workaround for G4Polyhedron bug 
   * developed analytic PMT representation
   * photons fully GPU resident, only copy PMT hits to CPU

   **Opticks Validation**

   * developed validation machinery *CfG4*
   * simple rainbow geometry matches Geant4
   * single PMT geometry matches Geant4

   **Next**

   * Analytic IAV, OAV descriptions (along optical path) 
   * AD, Full Geometry validations


   
:i:`JPMT Inside Wide`
----------------------

.. sidebar:: Opticks Overview

   .. class:: small
     
      * **200x Geant4** with mobile GPU
      * **> 1000x** expected (workstation GPUs) 
      * :red:`photon propagation time --> zero`
      * :blue:`analytic geometry --> precise G4 matching`


:i:`Blank Page`
----------------------



:i:`JPMT Wide`
----------------------


.. raw:: html

    <pre class="myfoot">
    http://simoncblyth.bitbucket.org/env/graphics/ggeoview/jpmt-wide_half.png
    </pre>





:i:`JPMT Before Contact`
-------------------------

.. class:: tiny

   http://simoncblyth.bitbucket.org/env/graphics/ggeoview/jpmt-before-contact_half.png


:i:`JPMT After Contact`
-------------------------

.. class:: tiny

   http://simoncblyth.bitbucket.org/env/graphics/ggeoview/jpmt-after-contact_half.png


:i:`JPMT Approach`
----------------------

.. class:: tiny

   http://simoncblyth.bitbucket.org/env/graphics/ggeoview/jpmt-approach_half.png


:i:`JPMT Arrival`
----------------------

.. class:: tiny

   http://simoncblyth.bitbucket.org/env/graphics/ggeoview/jpmt-arrival_half.png


:i:`JPMT Inside Outside`
-------------------------

.. class:: tiny

   http://simoncblyth.bitbucket.org/env/graphics/ggeoview/jpmt-inside-outside_half.png


.. sidebar:: Photon History Selection

   Only *CK BT BT BT SA*, three boundary transmits before surface absorption 


:i:`JPMT Headview`
----------------------

.. class:: tiny

   http://simoncblyth.bitbucket.org/env/graphics/ggeoview/jpmt-headview_half.png


:i:`JPMT Backview`
----------------------

.. class:: tiny

   http://simoncblyth.bitbucket.org/env/graphics/ggeoview/jpmt-backview_half.png



:small:`EXTRAS : Details and Tests in progress`
--------------------------------------------------

.. class:: small

   **Details**

   * Optical Photons now fully GPU resident
   * Volume to Surface Translation details need validation
   * OptiX Geometry Experience

   **Tests requiring G4 comparison**

   * Prism S-Polarized
   * Prism P-Polarized
   * Prism Deviation vs Incident angles for 10 wavelengths
   * Lens focussing 


:small:`Optical Photons now fully GPU resident`
--------------------------------------------------

.. class:: small

     All photon operations now done on GPU:

     * seeded (assigned gensteps)
     * generated 
     * propagated
     * indexed material/interaction histories 
     
     Only PMT hits need to be copied back to CPU


.. class:: tiny

     Thrust/CUDA/OptiX interop used to implement


:small:`Volume to Surface Translation details need validation`
------------------------------------------------------------------

.. class:: small
    
   Zoomed view of PMT edge (mm): showing 3mm Pyrex, 

   .. image:: /env/nuwa/detdesc/pmt/analytic-pmt-detail.png
      :width: 600px
      :align: center

   **Volume based geometry can get away with coincident
   boundaries, Surface based geometry cannot**


:small:`OptiX Geometry Experience`
--------------------------------------

.. class:: small

   **Geometry Issues Fixed/Avoidable**

   * triangulated geometry leaks when shoot millions of photons at cracks (1)
   
   * bounding boxes that touch geometry cause leaks, slightly   
     enlarging the boxes avoids leak (<1 in 3M)  
   

.. class:: tiny

    (1) more of a problem for testing than actual usage



:small:`Prism S-Polarized`
------------------------------------------------------------------

.. class:: small

    Quadrant of cylindrically directed S-polarized photons at 10 wavelengths (from 100 to 800 nm) 
    incident from left.  

.. class:: tiny

    S-polarization: perpendicular to incident plane

.. image:: /env/numerics/npy/prism-spol-ripple.png
   :width: 900px
   :align: center


:small:`Prism P-Polarized`
------------------------------------------------------------------

.. class:: small

    Gap in reflection at Brewsters angle is apparent where 
    the P-polarized photons can only be transmitted. 

.. class:: tiny

    P-polarization: not perpendicular to incident plane


.. image:: /env/numerics/npy/prism-ppol-ripple.png
   :width: 900px
   :align: center


:small:`Prism Deviation vs Incident angles for 10 wavelengths`
------------------------------------------------------------------

.. class:: small

   Prism geometry and Snell's law at two refractions allows deviation 
   angle vs incident angle to be predicted.  Comparison of simulation
   results with expectations for 10 wavelengths   
   using refractive index of Schott F2 Flint Glass.

.. image:: /env/numerics/npy/prism-deviation.png
   :width: 900px
   :align: center


:small:`Lens focussing`
----------------------------------------------------------

.. class:: small

    Lens constructed from intersection of two spheres.
    Disc parallel beam incident from left.
    Color represents polarization direction.  2nd reflections 
    are apparent. 


.. image:: /env/graphics/ggeoview/lens-polcolor.png
   :width: 900px
   :align: center






:small:`Opticks Absolute Reflection compared to Fresnel expectation`
-----------------------------------------------------------------------

.. class:: tiny

   Comparison of simulated absolute reflection of S and P polarized single events against 
   expectation from Fresnel formula. Using uniform planar incident cyclindrically directed light.

.. image:: /env/numerics/npy/reflection.png
   :width: 700px
   :align: center


:small:`1M Rainbow P-Polarized, Comparison Opticks/Geant4`
------------------------------------------------------------

.. class:: tiny

   Deviation angle(degrees) of 1M parallel monochromatic photons in disc shaped beam incident on water sphere.
   Numbered bands are visible range expectations of first 11 rainbows.
   P-Polarized intersection (E field within plane of incidence) arranged by directing polarization tangentially.

.. image:: /env/optix/cfg4/rainbow-cfg4-ppol.png
   :width: 800px
   :align: center



:small:`Large Geometry/Event Techniques`
------------------------------------------------------- 

.. sidebar:: JUNO Geometry 

   .. class:: small

      289733 volumes split into instanced: 
 
      * name: count (faces)
      * PMT_3inch: 36572 (540) 
      * PMT_20inch: 19452 (3502)
      * lFasteners: 480 (1856)
      * lPlane: 124 (6252) 

      And the rest:

      * Global     (95436)  
 

.. class:: small

   **Instancing implemented for OpenGL and OptiX**

   Geometry analysed to find instances

   * repeated sub-trees with transforms for each **instance** 
   * JUNO: ~90M triangles, instancing reduces to 0.1M

   **Switchable Rendering**

   * Multiple renderers: global, full instances, bbox instances
   * Rapid switching GUI control

   **Compute Mode**

   * Pure OptiX buffers faster (~7X interop)
   * Less GPU memory (1) 
   * Visualize by separate event loading  
      
   **Ideas to investigate**

   * Analytic PMT definition expected to improve OptiX efficiency 
   * Culling non-visible geometry to improve OpenGL performance
   * Level-of-detail : change geometry detail based on distance


.. class:: tiny  

   (1) Interop forced to duplicate data as OpenGL/OptiX geometry sharing not operational



:small:`JUNO Geometry Instance Rendering Control`
------------------------------------------------------- 

.. image:: /env/graphics/ggeoview/ggv-juno-instancing.png
   :width: 900px
   :align: center

   
:i:`JPMT Inside Wide`
----------------------

.. class:: tiny

   http://simoncblyth.bitbucket.org/env/graphics/ggeoview/jpmt-inside-wide_half.png






